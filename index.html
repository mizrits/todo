
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ToDo„É™„Çπ„Éà v2</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
      md-icon {
        font-family: 'Material Symbols Outlined';
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      }
      .check-button {
        --md-fab-container-color: #BEEFBB;
        --md-fab-icon-color: #1AA64A;
        --md-fab-icon-size: 35px;
      }
      .restore-button {
        --md-sys-color-on-surface-variant: #3271EA;
      }
      .delete-button {
        --md-sys-color-on-surface-variant: #dc362e;
      }
      .assist-box {
top: 100%;
        position: absolute;
        margin-top: 8px;
        background-color: #fff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        padding: 8px;
        border-radius: 4px;
        z-index: 10;
        width: 100%;
        box-sizing: border-box;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s ease;
      }
      .assist-box.visible {
        opacity: 1;
        visibility: visible;
      }
    </style>
    <script type="importmap">
      {
        "imports": {
          "@material/web/": "https://esm.run/@material/web/"
        }
      }
    </script>
    <script type="module">
      import '@material/web/all.js';
      import { styles as typescaleStyles } from '@material/web/typography/md-typescale-styles.js';
      document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
    </script>
    <style>
      body {
        font-family: sans-serif;
        margin: 2rem auto;
        padding: 1rem;
        max-width: 600px;
      }
      .task, .taskArchived {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        transition: opacity 1s ease;
      }
      .task { border-bottom: 1px solid #ccc; }
      .taskArchived { border-top: 1px solid #ccc; }
      .fade-out { opacity: 0; }
      .input-row {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        position: relative;
      }
      .input-row md-outlined-text-field {
        flex-grow: 1;
      }
      .splash-container {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 0;
      }
      .splash {
        position: absolute;
        background: limegreen;
        border-radius: 50%;
        animation: splash 1s ease-out forwards;
      }
      @keyframes splash {
        0% {
          opacity: 1;
          transform: scale(1) translate(0, 0);
        }
        100% {
          opacity: 0;
          transform: scale(0.5) translate(var(--dx), var(--dy));
        }
      }
      .skeleton {
        background-color: #ddd;
        border-radius: 4px;
        height: 1.5rem;
        margin: 0.5rem 0;
        animation: pulse 1.5s infinite ease-in-out;
      }
      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.4; }
        100% { opacity: 1; }
      }
      #archivedToggle {
        cursor: pointer;
        user-select: none;
        margin-bottom: 0.5rem;
      }
      #archivedList {
        overflow: hidden;
        max-height: 0;
        transition: max-height 0.5s ease;
      }
      #archivedSectionWrapper {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 1rem 1rem 1rem 1rem;
      }
      .icon-row {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <h1 class="md-typescale-headline-small">üìù ToDo„É™„Çπ„Éà</h1>

    <div class="input-row">
      <md-outlined-text-field id="taskInput" label="„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ"></md-outlined-text-field>
      <md-filled-button id="addButton">ËøΩÂä†</md-filled-button>
      <div class="assist-box" id="assistBox">
        <md-assist-chip>YYYYMMDD</md-assist-chip>
        <md-assist-chip>MMDD</md-assist-chip>
        <md-assist-chip>Á∑äÊÄ•</md-assist-chip>
        <md-assist-chip>ÈáçË¶Å</md-assist-chip>
        <md-assist-chip>„Äê„Äë</md-assist-chip>
      </div>
    </div>

    <div id="taskList"></div>

    <div id="archivedSectionWrapper" style="margin-top: 2rem;">
      <div id="archivedToggle" class="md-typescale-title-medium">‚úÖ ÂÆå‰∫ÜÊ∏à„Åø„Çø„Çπ„ÇØ</div>
      <div id="archivedList"></div>
    </div>

    <div class="splash-container"></div>

    <script type="module">
      const assistBox = document.getElementById('assistBox');
      const taskInput = document.getElementById('taskInput');
      const addButton = document.getElementById('addButton');
      const taskList = document.getElementById('taskList');
      const archivedList = document.getElementById('archivedList');
      const archivedToggle = document.getElementById('archivedToggle');
      const archivedSectionWrapper = document.getElementById('archivedSectionWrapper');
      const chips = document.querySelectorAll('md-assist-chip');
      const scriptURL = 'https://script.google.com/macros/s/ID/exec';

      let archivedOpen = false;

      archivedToggle.addEventListener('click', () => {
        archivedOpen = !archivedOpen;
        archivedList.style.maxHeight = archivedOpen ? archivedList.scrollHeight + 'px' : '0';
      });

      customElements.whenDefined('md-outlined-text-field').then(() => {
        requestAnimationFrame(() => {
          const inputEl = taskInput.shadowRoot.querySelector('input');

          inputEl.addEventListener('focus', () => {
            assistBox.classList.add('visible');
            assistBox.style.visibility = 'visible';
          });

          inputEl.addEventListener('blur', () => {
            setTimeout(() => {
              assistBox.classList.remove('visible');
              setTimeout(() => {
                if (!assistBox.classList.contains('visible')) {
                  assistBox.style.visibility = 'hidden';
                }
              }, 500);
            }, 500);
          });

          chips.forEach(chip => {
            chip.addEventListener('click', () => {
              let value = chip.textContent.trim();
              if (value === 'YYYYMMDD') {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                value = `${yyyy}${mm}${dd}`;
              }
              if (value === 'MMDD') {
                const today = new Date();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                value = `${mm}${dd}`;
              }
              const cursorPos = inputEl.selectionStart;
              const text = inputEl.value;
              const newText = text.slice(0, cursorPos) + value + text.slice(cursorPos);
              inputEl.value = newText;
              inputEl.setSelectionRange(cursorPos + value.length, cursorPos + value.length);
              taskInput.value = inputEl.value;
              assistBox.classList.remove('visible');
              setTimeout(() => {
                if (!assistBox.classList.contains('visible')) {
                  assistBox.style.visibility = 'hidden';
                }
              }, 500);
            });
          });
        });
      });

      function setInputEnabled(enabled) {
        addButton.disabled = !enabled;
        taskInput.disabled = !enabled;
      }

      function triggerSplash(event) {
        const btn = event.currentTarget;
        const rect = btn.getBoundingClientRect();
        const offsetX = -4;
        const offsetY = -7;
        const originX = rect.left + rect.width / 2 + offsetX;
        const originY = rect.top + rect.height / 2 + offsetY;
        const container = document.querySelector('.splash-container');
        const count = 30;

        for (let i = 0; i < count; i++) {
          const splash = document.createElement('div');
          splash.className = 'splash';
          const angle = Math.random() * Math.PI * 2;
          const distance = 40 + Math.random() * 60;
          const dx = Math.cos(angle) * distance + 'px';
          const dy = Math.sin(angle) * distance + 'px';
          const size = 5 + Math.random() * 8;
          splash.style.width = `${size}px`;
          splash.style.height = `${size}px`;
          splash.style.left = `${originX}px`;
          splash.style.top = `${originY}px`;
          splash.style.setProperty('--dx', dx);
          splash.style.setProperty('--dy', dy);
          container.appendChild(splash);
          setTimeout(() => splash.remove(), 1000);
        }
      }

      function showSkeletonLoader(count = 5) {
        taskList.innerHTML = '';
        archivedList.innerHTML = '';
        archivedSectionWrapper.style.display = 'none';
        for (let i = 0; i < count; i++) {
          const skeleton = document.createElement('div');
          skeleton.className = 'skeleton';
          taskList.appendChild(skeleton);
        }
      }

      async function loadTasks() {
        showSkeletonLoader();
        try {
          const res = await fetch(`${scriptURL}?method=list`);
          const data = await res.json();
          taskList.innerHTML = '';
          archivedList.innerHTML = '';
          archivedSectionWrapper.style.display = '';
          archivedList.style.maxHeight = archivedOpen ? archivedList.scrollHeight + 'px' : '0';

          data.active.forEach(task => {
            const div = document.createElement('div');
            div.className = 'task';

            const span = document.createElement('span');
            span.textContent = task;

            const checkBtn = document.createElement('md-fab');
            checkBtn.setAttribute('class', 'check-button');
            checkBtn.setAttribute('aria-label', 'ÂÆå‰∫Ü');
            checkBtn.innerHTML = '<md-icon slot="icon">task_alt</md-icon>';
            checkBtn.addEventListener('click', (e) => {
              triggerSplash(e);
              div.classList.add('fade-out');
              div.addEventListener('transitionend', async () => {
                await archiveTask(task);
              }, { once: true });
            });

            div.appendChild(span);
            div.appendChild(checkBtn);
            taskList.appendChild(div);
          });

          data.archived.forEach(task => {
            const div = document.createElement('div');
            div.className = 'taskArchived';

            const span = document.createElement('span');
            span.textContent = task;

            const iconRow = document.createElement('div');
            iconRow.className = 'icon-row';

            const restoreBtn = document.createElement('md-outlined-icon-button');
            restoreBtn.setAttribute('class', 'restore-button');
            restoreBtn.setAttribute('aria-label', 'Âæ©ÂÖÉ');
            restoreBtn.innerHTML = '<md-icon>undo</md-icon>';
            restoreBtn.addEventListener('click', async () => {
              await restoreTask(task);
            });

            const deleteBtn = document.createElement('md-outlined-icon-button');
            deleteBtn.setAttribute('class', 'delete-button');
            deleteBtn.setAttribute('aria-label', 'ÂâäÈô§');
            deleteBtn.innerHTML = '<md-icon>delete</md-icon>';
            deleteBtn.addEventListener('click', (e) => {
              div.classList.add('fade-out');
              div.addEventListener('transitionend', async () => {
                await deleteTask(task);
              }, { once: true });
            });

            iconRow.appendChild(restoreBtn);
            iconRow.appendChild(deleteBtn);

            div.appendChild(span);
            div.appendChild(iconRow);
            archivedList.appendChild(div);
          });
        } catch (err) {
          taskList.innerHTML = 'Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
        }
      }

      async function addTask() {
        const task = taskInput.value.trim();
        if (!task) return;
        setInputEnabled(false);
        try {
          const res = await fetch(`${scriptURL}?method=add&task=${encodeURIComponent(task)}`);
          const json = await res.json();
          if (json.status === 'error' && json.message === 'duplicate') {
            alert('Âêå„Åò„Çø„Çπ„ÇØ„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô');
          } else {
            taskInput.value = '';
            await loadTasks();
          }
        } catch (err) {
          console.error('ËøΩÂä†Â§±Êïó', err);
        } finally {
          setInputEnabled(true);
        }
      }

      async function archiveTask(task) {
        await fetch(`${scriptURL}?method=archive&task=${encodeURIComponent(task)}`);
        await loadTasks();
      }

      async function restoreTask(task) {
        await fetch(`${scriptURL}?method=restore&task=${encodeURIComponent(task)}`);
        await loadTasks();
      }

      async function deleteTask(task) {
        await fetch(`${scriptURL}?method=delete&task=${encodeURIComponent(task)}`);
        await loadTasks();
      }

      addButton.addEventListener('click', addTask);
      window.addEventListener('DOMContentLoaded', loadTasks);
    </script>
  </body>
</html>

